<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Habit Tracker</title>

<style>
body{background:#131a19;color:white;font-family:Arial;}
button{margin:4px;padding:6px 12px;}
table{border-collapse:collapse;width:100%;margin-top:10px;}
th,td{border:1px solid #444;padding:6px;text-align:center;}
th{background:#222;}
.day:nth-child(even){background:#1f1f1f;}
.day:nth-child(odd){background:#2b2b2b;}
input[type=text]{width:280px;background:#000;color:white;border:none;font-weight:bold;}
input[type=time]{background:#000;color:white;border:none;font-weight:bold;}
.streak{font-weight:bold;}
#report{display:none;margin-top:20px;background:#1e1e1e;padding:12px;}
canvas{background:#111;margin-top:10px;}
</style>
</head>

<body>

<h2>Habit Tracker</h2>

<button onclick="changeDays(7)">7 Days</button>
<button onclick="changeDays(15)">15 Days</button>
<button onclick="changeDays(30)">30 Days</button>
<button onclick="addRow()">+ Add Task</button>
<button onclick="removeRow()">âˆ’ Remove Task</button>

<table id="tracker"></table>

<div id="report">
  <h3>Final Report</h3>
  <p id="textReport"></p>
  <canvas id="pie" width="260" height="260"></canvas>
  <canvas id="bar" width="420" height="220"></canvas>
</div>

<script>
let totalDays = 30;

/* ---------- MONTH RESET ---------- */
function autoReset(){
  const now=new Date(), m=localStorage.getItem("month");
  if(m===null){
    localStorage.setItem("month",now.getMonth());
    localStorage.setItem("startDate",now.toISOString());
    return;
  }
  if(+m!==now.getMonth()){
    localStorage.clear();
    localStorage.setItem("month",now.getMonth());
    localStorage.setItem("startDate",now.toISOString());
    location.reload();
  }
}

/* ---------- START DATE ---------- */
function startDate(){
  let d=localStorage.getItem("startDate");
  if(!d){
    d=new Date().toISOString();
    localStorage.setItem("startDate",d);
  }
  return new Date(d);
}

/* ---------- DAY INDEX (MIDNIGHT BASED) ---------- */
function todayIndex(){
  const s=startDate();
  const startMid=new Date(s.getFullYear(),s.getMonth(),s.getDate());
  const now=new Date();
  const todayMid=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  const diff=Math.floor((todayMid-startMid)/(1000*60*60*24));
  return Math.min(diff+1,totalDays);
}

/* ---------- TABLE ---------- */
function buildTable(){
  tracker.innerHTML="";
  let h="<tr><th>Time</th><th>Task</th>";
  for(let i=1;i<=totalDays;i++) h+=`<th>Day ${i}</th>`;
  h+="<th>Streak</th></tr>";
  tracker.innerHTML=h;
}

/* ---------- ROWS ---------- */
function addRow(save=true){
  const tr=document.createElement("tr");
  let html=`<td><input type="time"></td><td><input type="text"></td>`;
  for(let i=0;i<totalDays;i++) html+=`<td class="day"><input type="checkbox"></td>`;
  html+=`<td class="streak">0</td>`;
  tr.innerHTML=html;
  tracker.appendChild(tr);
  setupRow(tr);
  if(save) saveData();
}

function removeRow(){
  if(tracker.rows.length>2){
    tracker.deleteRow(-1);
    saveData();
  }
}

/* ---------- ROW LOGIC ---------- */
function setupRow(row){
  const today=todayIndex();
  row.querySelectorAll(".day input").forEach((cb,i)=>{
    cb.disabled=(i+1!==today);
    cb.onchange=()=>{
      if(cb.checked){
        cb.disabled=true;
        updateStreak(row);
        saveData();
        checkFinalReport();
      }
    };
  });
  row.querySelector("input[type=text]").oninput=saveData;
  row.querySelector("input[type=time]").onchange=saveData;
}

function updateStreak(row){
  let s=0;
  row.querySelectorAll(".day input").forEach(c=>{if(c.checked)s++;});
  row.querySelector(".streak").innerText=s;
}

/* ---------- STORAGE ---------- */
function saveData(){
  const data={
    totalDays,
    rows:[...tracker.rows].slice(1).map(r=>({
      task:r.querySelector("input[type=text]").value,
      time:r.querySelector("input[type=time]").value,
      checks:[...r.querySelectorAll(".day input")].map(c=>c.checked)
    }))
  };
  localStorage.setItem("habitData",JSON.stringify(data));
}

function loadData(){
  const s=localStorage.getItem("habitData");
  if(!s){
    for(let i=0;i<5;i++) addRow(false);
    return;
  }
  const d=JSON.parse(s);
  d.rows.forEach(r=>{
    addRow(false);
    const row=tracker.rows[tracker.rows.length-1];
    row.querySelector("input[type=text]").value=r.task;
    row.querySelector("input[type=time]").value=r.time;
    row.querySelectorAll(".day input").forEach((c,i)=>{
      if(r.checks[i]){c.checked=true;c.disabled=true;}
    });
    updateStreak(row);
  });
}

/* ---------- DAY BUTTONS ---------- */
function changeDays(d){
  if(totalDays===d) return;
  totalDays=d;
  buildTable();
  loadData();
  saveData();
}

/* ---------- CHARTS ---------- */
function drawPie(done,total){
  const ctx=pie.getContext("2d");
  ctx.clearRect(0,0,260,260);
  const a=(done/total)*Math.PI*2;
  ctx.fillStyle="#4caf50";
  ctx.beginPath();ctx.moveTo(130,130);ctx.arc(130,130,100,0,a);ctx.fill();
  ctx.fillStyle="#555";
  ctx.beginPath();ctx.moveTo(130,130);ctx.arc(130,130,100,a,Math.PI*2);ctx.fill();
}

function drawBarPerTask(rows){
  const ctx=bar.getContext("2d");
  ctx.clearRect(0,0,420,220);
  const barW=30,gap=15,base=190,maxH=150;
  rows.forEach((r,i)=>{
    const pct=r.checks.filter(v=>v).length/totalDays;
    const h=pct*maxH;
    ctx.fillStyle="#4caf50";
    ctx.fillRect(30+i*(barW+gap),base-h,barW,h);
    ctx.fillStyle="#fff";
    ctx.fillText(`T${i+1}`,30+i*(barW+gap),205);
  });
}

/* ---------- FINAL REPORT ---------- */
function checkFinalReport(){
  if(todayIndex()!==totalDays) return;
  const d=JSON.parse(localStorage.getItem("habitData"));
  let done=0,total=0;
  d.rows.forEach(r=>r.checks.forEach(v=>{total++;if(v)done++;}));
  report.style.display="block";
  textReport.innerText=`Completed ${done}/${total} (${Math.round(done/total*100)}%)`;
  drawPie(done,total);
  drawBarPerTask(d.rows);
}

/* ---------- INIT ---------- */
autoReset();
buildTable();
loadData();
</script>

</body>
</html>
