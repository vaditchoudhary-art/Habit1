<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Habit Tracker</title>

<style>
body{
  background:#131a19;
  color:white;
  font-family:Arial,sans-serif;
}
button{margin:4px;padding:6px 12px;}
table{border-collapse:collapse;width:100%;margin-top:10px;}
th,td{border:1px solid #444;padding:6px;text-align:center;}
th{background:#222;}
.day:nth-child(even){background:#1f1f1f;}
.day:nth-child(odd){background:#2b2b2b;}
input[type=text]{width:280px;background:#000;color:white;border:none;font-weight:bold;}
input[type=time]{background:#000;color:white;border:none;font-weight:bold;}
.streak{font-weight:bold;}
#report{display:none;margin-top:20px;background:#1e1e1e;padding:12px;}
canvas{background:#111;margin-top:10px;}
</style>
</head>

<body>

<h2>Habit Tracker</h2>

<button onclick="changeDays(7)">7 Days</button>
<button onclick="changeDays(15)">15 Days</button>
<button onclick="changeDays(30)">30 Days</button>
<button onclick="addRow()">+ Add Task</button>
<button onclick="removeRow()">− Remove Task</button>

<table id="tracker"></table>

<div id="report">
  <h3>Final Report</h3>
  <p id="textReport"></p>
  <canvas id="pie" width="260" height="260"></canvas>
  <canvas id="bar" width="360" height="200"></canvas>
</div>

<script>
let totalDays = 30;

function autoReset(){
  const now=new Date();
  const m=localStorage.getItem("month");
  if(m===null){
    localStorage.setItem("month",now.getMonth());
    localStorage.setItem("startDate",now.toISOString());
    return;
  }
  if(parseInt(m)!==now.getMonth()){
    localStorage.clear();
    localStorage.setItem("month",now.getMonth());
    localStorage.setItem("startDate",now.toISOString());
    location.reload();
  }
}

function startDate(){
  let d=localStorage.getItem("startDate");
  if(!d){
    d=new Date().toISOString();
    localStorage.setItem("startDate",d);
  }
  return new Date(d);
}

function todayIndex(){
  const diff=Math.floor((new Date()-startDate())/(1000*60*60*24));
  return Math.min(diff+1,totalDays);
}

function buildTable(){
  const t=document.getElementById("tracker");
  t.innerHTML="";
  let h="<tr><th>Time</th><th>Task</th>";
  for(let i=1;i<=totalDays;i++) h+=`<th>Day ${i}</th>`;
  h+="<th>Streak</th></tr>";
  t.innerHTML=h;
}

function addRow(save=true){
  const tr=document.createElement("tr");
  let html=`<td><input type="time"></td>
            <td><input type="text" placeholder="Task"></td>`;
  for(let i=0;i<totalDays;i++)
    html+=`<td class="day"><input type="checkbox"></td>`;
  html+=`<td class="streak">0</td>`;
  tr.innerHTML=html;
  document.getElementById("tracker").appendChild(tr);
  setupRow(tr);
  if(save) saveData();
}

function removeRow(){
  const t=document.getElementById("tracker");
  if(t.rows.length>2){
    t.deleteRow(-1);
    saveData();
  }
}

function setupRow(row){
  const today=todayIndex();
  row.querySelectorAll(".day input").forEach((cb,i)=>{
    if(i+1!==today) cb.disabled=true;
    cb.onchange=()=>{
      if(cb.checked){
        cb.disabled=true;
        updateStreak(row);
        saveData();
        checkFinalReport();
      }
    };
  });
  row.querySelector("input[type=text]").oninput=saveData;
  row.querySelector("input[type=time]").onchange=saveData;
}

function updateStreak(row){
  let s=0;
  row.querySelectorAll(".day input").forEach(c=>{if(c.checked)s++;});
  row.querySelector(".streak").innerText=s;
}

function saveData(){
  const data={totalDays,rows:[]};
  document.querySelectorAll("#tracker tr").forEach((r,i)=>{
    if(i===0) return;
    data.rows.push({
      time:r.querySelector("input[type=time]").value,
      task:r.querySelector("input[type=text]").value,
      checks:[...r.querySelectorAll(".day input")].map(c=>c.checked)
    });
  });
  localStorage.setItem("habitData",JSON.stringify(data));
}

function loadData(){
  const s=localStorage.getItem("habitData");
  if(!s){
    for(let i=0;i<5;i++) addRow(false);
    return;
  }
  const d=JSON.parse(s);
  totalDays=d.totalDays||totalDays;
  buildTable();
  d.rows.forEach(r=>{
    addRow(false);
    const row=document.querySelector("#tracker tr:last-child");
    row.querySelector("input[type=time]").value=r.time;
    row.querySelector("input[type=text]").value=r.task;
    row.querySelectorAll(".day input").forEach((c,i)=>{
      if(r.checks[i]){
        c.checked=true;
        c.disabled=true;
      }
    });
    updateStreak(row);
  });
}

function changeDays(d){
  if(totalDays===d) return;   // ✅ prevent duplicate rebuild
  totalDays=d;
  buildTable();
  loadData();                 // ❌ no save here (IMPORTANT)
}

function drawPie(done,total){
  const c=document.getElementById("pie"),ctx=c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  const angle=(done/total)*Math.PI*2;
  ctx.fillStyle="#4caf50";
  ctx.beginPath();
  ctx.moveTo(130,130);
  ctx.arc(130,130,100,0,angle);
  ctx.fill();
  ctx.fillStyle="#555";
  ctx.beginPath();
  ctx.moveTo(130,130);
  ctx.arc(130,130,100,angle,Math.PI*2);
  ctx.fill();
}

function drawBar(done,total){
  const c=document.getElementById("bar"),ctx=c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  ctx.fillStyle="#4caf50";
  ctx.fillRect(60,180-(done/total)*150,60,(done/total)*150);
  ctx.fillStyle="#f44336";
  ctx.fillRect(160,180-((total-done)/total)*150,60,((total-done)/total)*150);
}

function checkFinalReport(){
  if(todayIndex()!==totalDays) return;
  let done=0,total=0;
  document.querySelectorAll(".day input").forEach(c=>{
    total++;
    if(c.checked) done++;
  });
  document.getElementById("report").style.display="block";
  document.getElementById("textReport").innerText=
    `Completed ${done}/${total} (${Math.round(done/total*100)}%)`;
  drawPie(done,total);
  drawBar(done,total);
}

autoReset();
buildTable();
loadData();
</script>

</body>
</html>
